
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Super Slick Agile Puppet for Devops - Just Another Linux Blog</title>
  <meta name="author" content="Chris Cowley">

  
  <meta name="description" content="With a superb buzzword laden title like that, then I reckon massive traffic boost is inevitable. Puppet is my favourite Configuration Management tool &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.chriscowley.me.uk/blog/2014/06/25/super-slick-agile-puppet-for-devops/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Just Another Linux Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript">
    // Avoid conflict with ender.js.
    jQuery.noConflict();
</script>
<!-- jQuery Form Plugin -->
<script src="http://malsup.github.com/jquery.form.js"></script>
<!-- jQuery Form Validation Plugin -->
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script> 
<script src="/javascripts/google_form.js"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32843690-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Just Another Linux Blog</a></h1>
  
    <h2>maybe a bit about cycling as well</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.duckduckgo.com/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sites" value="site:www.chriscowley.me.uk" />
    <input class="search" type="text" name="q" results="0" placeholder="Search&hellip;"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/consulting">Consulting</a></li>
  <li><a href="/yum">Yum</a></li>
  <li><a href="/contact">Contact</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Super Slick Agile Puppet for Devops</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-25T21:22:00+02:00" pubdate data-updated="true">Wednesday 25 June 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p><img class="right" src="http://i.imgur.com/3SJXbMb.jpg">With a superb buzzword laden title like that, then I reckon massive traffic boost is inevitable.</p>

<p>Puppet is my favourite Configuration Management tool. This is not a post to try and persuade anyone not to use Ansible, Chef or any other. What I want to do is show I build Puppet based infrastuctures in such away that it meets all the basic tenets of DevOps/Agile/buzzword-of-the-month.</p>

<!-- more -->


<p>What to we need:</p>

<ul>
<li>CentOS 6 - RHEL/CentOS is pretty much the defacto enterprise distro. This will easily translate to Debian/Ubuntu or anything else.</li>
<li>Puppet 3 - I like a traditional Master/Agent set up, if you prefer master-less good for you. This is my blog, my rules.</li>
<li>Git</li>
<li>Dynamic Environments</li>
<li>PuppetDB</li>
<li>Hiera</li>
<li>Jenkins</li>
</ul>


<p>All the config is stored in Git, with Jenkins watching it.</p>

<p>Puppet tends to fall apart pretty quickly if you do not have DNS in place. You can start using host files, but that will get old quickly. Ideally, the first thing you will do with Puppet is install a DNS server managed by Puppet. Maybe that will be the next post.</p>

<h1>Puppet</h1>

<p>Starting with a base Centos 6 install, the installation is very easy:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum -y install http://yum.puppetlabs.com/puppetlabs-release-el-6.noarch.rpm
</span><span class='line'>yum -y install puppet puppet-server rubygem-activerecord</span></code></pre></td></tr></table></div></figure>


<p>Our environments need a place to go, so create that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir /etc/puppet/environments
</span><span class='line'>chgrp puppet /etc/puppet/environments
</span><span class='line'>chmod 2775 /etc/puppet/environments</span></code></pre></td></tr></table></div></figure>


<p>The configuration will look like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[main]
</span><span class='line'>    logdir = /var/log/puppet
</span><span class='line'>    rundir = /var/run/puppet
</span><span class='line'>    ssldir = $vardir/ssl
</span><span class='line'>    trusted_node_data = true
</span><span class='line'>    pluginsync = true
</span><span class='line'>    
</span><span class='line'>[agent]
</span><span class='line'>    classfile = $vardir/classes.txt
</span><span class='line'>    localconfig = $vardir/localconfig
</span><span class='line'>    report = true
</span><span class='line'>    environment = production
</span><span class='line'>    ca_server = puppet.chriscowley.lan
</span><span class='line'>    server = puppet.chriscowley.lan
</span><span class='line'>    
</span><span class='line'>[master]
</span><span class='line'>    environmentpath = $confdir/environments
</span><span class='line'>    # Passenger
</span><span class='line'>    ssl_client_header        = SSL_CLIENT_S_DN
</span><span class='line'>    ssl_client_verify_header = SSL_CLIENT_VERIFY</span></code></pre></td></tr></table></div></figure>


<p>Do not use the Puppetmaster service. It uses Webrick, which is bad. Any more than 5 agents and it will start slowing down. Puppet is a RoR app, so stick it behind <a href="http://docs.puppetlabs.com/guides/passenger.html">Apache/Passenger</a>. We installed the <code>puppet-server</code> package for a simple reason: when you start it the first time, it will create your SSL certificates automatically. After that initial start you can stop it and forget it ever existed. So just run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service puppetmaster start
</span><span class='line'>service puppetmaster stop</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, you will need to put SELinux into Permissive mode temporarily. Once you have fired it up you can <a href="http://wiki.centos.org/HowTos/SELinux#head-faa96b3fdd922004cdb988c1989e56191c257c01">build a local policy</a> and re-enable it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install httpd httpd-devel mod_ssl ruby-devel rubygems gcc gcc-c++ curl-devel openssl-devel zlib-devel
</span><span class='line'>gem install rack passenger
</span><span class='line'>passenger-install-apache2-module</span></code></pre></td></tr></table></div></figure>


<p>Next you need to configure Apache to serve up the RoR app.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -p /usr/share/puppet/rack/puppetmasterd
</span><span class='line'>mkdir /usr/share/puppet/rack/puppetmasterd/public /usr/share/puppet/rack/puppetmasterd/tmp
</span><span class='line'>cp /usr/share/puppet/ext/rack/config.ru /usr/share/puppet/rack/puppetmasterd/
</span><span class='line'>chown puppet:puppet /usr/share/puppet/rack/puppetmasterd/config.ru
</span><span class='line'>https://gist.githubusercontent.com/chriscowley/00e75ee021ce314fab1e/raw/c87abc38182eafc6d22a80d13078ac044fdde49f/puppetmaster.conf | sed 's/puppet-server.example.com/puppet.yourlan.lan/g'</span></code></pre></td></tr></table></div></figure>


<p>You will need to modify the <code>sed</code> command in the last line to match your environment.</p>

<p>You may also need to change the Passenger paths to match what the output of <code>passenger-install-apache2-module</code> told you. It is up to date as of the time of writing.</p>

<h1>Hiera</h1>

<p>Your config file (<code>/etc/puppet/hiera.yaml</code>) will already be created, mine looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>:backends:
</span><span class='line'>  - yaml
</span><span class='line'>:hierarchy:
</span><span class='line'>  - defaults
</span><span class='line'>  - "nodes/%{clientcert}"
</span><span class='line'>  - "virtual/%{::virtual}"
</span><span class='line'>  - "%{environment}"
</span><span class='line'>  - "%{::osfamily}"
</span><span class='line'>  - global
</span><span class='line'>
</span><span class='line'>:yaml:
</span><span class='line'>  :datadir: "/etc/puppet/environments/%{::environment}/hieradata"</span></code></pre></td></tr></table></div></figure>


<p>There is also an <code>/etc/hiera.yaml</code> which Puppet does not use. change this to a symbolic link to avoid confusion.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ln -svf /etc/puppet/hiera.yaml /etc/hiera.yaml</span></code></pre></td></tr></table></div></figure>


<p>If you were to test it now, you will see a few errors:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Info: Retrieving pluginfacts
</span><span class='line'>Error: /File[/var/lib/puppet/facts.d]: Could not evaluate: Could not retrieve information from environment production source(s) puppet://puppet/pluginfacts
</span><span class='line'>Info: Retrieving plugin
</span><span class='line'>Error: /File[/var/lib/puppet/lib]: Could not evaluate: Could not retrieve information from environment production source(s) puppet://puppet/plugins</span></code></pre></td></tr></table></div></figure>


<p>Don&#8217;t worry about that for now, the important thing is that the agent connects to the master. If that happens the master does return an HTTP error, then you are good.</p>

<h1>R10k</h1>

<p>This is the tool I use to manage my modules. It can pull them off the Forge, or from wherever you tell it too. Most often that will be Github, or an internal Git repo if that&#8217;s what you use.</p>

<p>You need to install it from Ruby Gems, then there is a little configuration to do.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>gem install r10k
</span><span class='line'>mkdir /var/cache/r10k
</span><span class='line'>chgrp puppet /var/cache/r10k
</span><span class='line'>chmod 2775 /var/cache/r10k</span></code></pre></td></tr></table></div></figure>


<p>The file <code>/etc/r10k.yaml</code> should contain:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># location for cached repos
</span><span class='line'>:cachedir: '/var/cache/r10k'
</span><span class='line'>
</span><span class='line'># git repositories containing environments
</span><span class='line'>:sources:
</span><span class='line'>  :base:
</span><span class='line'>    remote: '/srv/puppet.git'
</span><span class='line'>    basedir: '/etc/puppet/environments'
</span><span class='line'>
</span><span class='line'># purge non-existing environments found here
</span><span class='line'>:purgedirs:
</span><span class='line'>  - '/etc/puppet/environments'</span></code></pre></td></tr></table></div></figure>


<h1>Git</h1>

<p>The core of your this process is the ubiquitous Git.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install git</span></code></pre></td></tr></table></div></figure>


<p>You need a Git repo to store everything, and also launch a deploy script when you push to it. To start with we&#8217;ll put it on the Puppet server. In the future I would put this on a dedicated machine, have Jenkins run tests, then run the deploy script on success.</p>

<p>However, it is not a standard repository, so you cannot just run <code>git init</code>. It needs:</p>

<ul>
<li>To be <strong>bare</strong></li>
<li>To be <strong>shared</strong></li>
<li>Have the <strong>master</strong> branch renamed to <strong>production</strong></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir -pv /srv/puppet.git
</span><span class='line'>git init --bare --shared=group /srv/puppet.git
</span><span class='line'>chgrp -R puppet /srv/puppet.git
</span><span class='line'>cd /srv/puppet.git
</span><span class='line'>git symbolic-ref HEAD refs/heads/production</span></code></pre></td></tr></table></div></figure>


<p>Continuing to work as root is not acceptable, so create user (if you do not already have one).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>useradd &lt;username&gt;
</span><span class='line'>usermod -G wheel,puppet &lt;username&gt;
</span><span class='line'>visudo</span></code></pre></td></tr></table></div></figure>


<p>Uncomment the line that reads:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%wheel        ALL=(ALL)       ALL</span></code></pre></td></tr></table></div></figure>


<p>This gives your user full <code>sudo</code> privileges.</p>

<h1>Deploy script</h1>

<p>This is what does the magic stuff. It needs to be <code>/srv/puppet.git/hooks/post-receive</code> so that it runs when you push something to this repository.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>umask 0002
</span><span class='line'>
</span><span class='line'>while read oldrev newrev ref
</span><span class='line'>do
</span><span class='line'>    branch=$(echo $ref | cut -d/ -f3)
</span><span class='line'>    echo
</span><span class='line'>    echo "--&gt; Deploying ${branch}..."
</span><span class='line'>    echo
</span><span class='line'>    r10k deploy environment $branch -p
</span><span class='line'>    # sometimes r10k gets permissions wrong too
</span><span class='line'>    find /etc/puppet/environments/$branch/modules -type d -exec chmod 2775 {} \; 2&gt; /dev/null
</span><span class='line'>    find /etc/puppet/environments/$branch/modules -type f -exec chmod 664 {} \; 2&gt; /dev/null
</span><span class='line'>done</span></code></pre></td></tr></table></div></figure>


<p>Run <code>chmod 0775 /srv/puppet.git/hooks/post-receive</code> to make is executable and writable by anyone in the <code>puppet</code> group.</p>

<h1>The first environment</h1>

<p>Switch to your user</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>su - &lt;username&gt;</span></code></pre></td></tr></table></div></figure>


<p>Clone the repository and create the necessary folder structure:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone /srv/puppet.git
</span><span class='line'>cd puppet
</span><span class='line'>mkdir -pv hieradata/nodes manifests site</span></code></pre></td></tr></table></div></figure>


<p>Now you can create <code>PuppetFile</code> in the root of that repository. This is what tells R10k what modules to deploy.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Puppet Forge
</span><span class='line'>mod 'puppetlabs/ntp', '3.0.0-rc1'
</span><span class='line'>mod 'puppetlabs/puppetdb', '3.0.1'
</span><span class='line'>mod 'puppetlabs/stdlib', '3.2.1'
</span><span class='line'>mod 'puppetlabs/concat', '1.0.0'
</span><span class='line'>mod 'puppetlabs/inifile', '1.0.3'
</span><span class='line'>mod 'puppetlabs/postgresql', '3.3.3'
</span><span class='line'>mod 'puppetlabs/firewall', '1.0.2'
</span><span class='line'>mod 'chriscowley/yumrepos', '0.0.2'
</span><span class='line'>
</span><span class='line'># Get a module from Github
</span><span class='line'>#mod 'custom',
</span><span class='line'>#  :git =&gt; 'https://github.com/chriscowley/puppet-pydio.git',
</span><span class='line'>#  :ref =&gt; 'master'</span></code></pre></td></tr></table></div></figure>


<p>A common error I make if I am not looking properly is to put the SSH URL from Github in there. This will not work unless you have added your SSH key on the Puppet server. Better just to put the HTTPS URL in there, there is need to write back to it after all.</p>

<p>Next you need to tell Puppet what agents should get what. To begin with, everything will get NTP, but only the Puppetmaster will get PuppetDB. To that end create <code>hieradata/common.yaml</code> with this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>classes:
</span><span class='line'>  - ntp
</span><span class='line'>
</span><span class='line'>ntp::servers:
</span><span class='line'>  - 0.pool.ntp.org
</span><span class='line'>  - 1.pool.ntp.org
</span><span class='line'>  - 2.pool.ntp.org
</span><span class='line'>  - 3.pool.ntp.org</span></code></pre></td></tr></table></div></figure>


<p>Next create <code>hieradata/nodes/$(hostname -s).yaml</code> with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>classes:
</span><span class='line'>  - puppetdb
</span><span class='line'>  - puppetdb::master::config</span></code></pre></td></tr></table></div></figure>


<p>Finally, you need to tell Puppet to get the data from Hiera. Create <code>manifests.site.pp</code> with</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hiera_include('classes')</span></code></pre></td></tr></table></div></figure>


<p>You should need nothing else.</p>

<p>Now you can push it to the master repository.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git add .
</span><span class='line'>git commit -a -m "Initial commit"
</span><span class='line'>git branch -m production
</span><span class='line'>git push origin production</span></code></pre></td></tr></table></div></figure>


<h1>Testing</h1>

<p>Of course, the whole point of all this is that we do as much testing as we can before any sort of deploy. We also want to keep our Git repository nice clean (especially if you push it to Github), so if we can avoid commits with stupid errors that would be great.</p>

<p>To perform your testing you need to replicate your production environment. From now on, I&#8217;m going to assume that you are working on your own workstation.</p>

<p>Clone your repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone ssh://&lt;username&gt;@puppet.example.com/srv/puppet.git
</span><span class='line'>cd puppet</span></code></pre></td></tr></table></div></figure>


<p>To perform all the testing, <a href="http://rvm.io/">RVM</a> is your friend. This allows you to replicate the ruby environment on the master, have all the necessary gems installed in a contained environment and sets you up to integrate with Jenkins later. Install is with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -sSL https://get.rvm.io | bash -s stable</span></code></pre></td></tr></table></div></figure>


<p>Follow any instructions it gives your, then you can create your environment. This will be using a old version of ruby as we are running CentOS 6 on the master.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rvm install ruby-1.8.7
</span><span class='line'>rvm use ruby-1.8.7
</span><span class='line'>rvm gemset create puppet
</span><span class='line'>rvm gemset use puppet
</span><span class='line'>rvm --create use ruby-1.8.7-head@puppet --rvmrc</span></code></pre></td></tr></table></div></figure>


<p>Create a Gemfile that contains:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source 'https://rubygems.org'
</span><span class='line'> 
</span><span class='line'>gem 'puppet-lint', '0.3.2'
</span><span class='line'>gem 'puppet', '3.6.2'
</span><span class='line'>gem 'kwalify', '0.7.2'</span></code></pre></td></tr></table></div></figure>


<p>Now you can install the gems with <code>bundle install</code>.</p>

<p>The tests will be run by a pre-commit hook script, that looks something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'># pre-commit git hook to check the validity of a puppet main manifest
</span><span class='line'>#
</span><span class='line'># Prerequisites:
</span><span class='line'># gem install puppet-lint puppet
</span><span class='line'>#
</span><span class='line'># Install:
</span><span class='line'># /path/to/repo/.git/hooks/pre-commit
</span><span class='line'>#
</span><span class='line'># Authors:
</span><span class='line'># Chris Cowley &lt;chris@chriscowley.me.uk&gt;
</span><span class='line'>
</span><span class='line'>echo "Checking style"
</span><span class='line'>for file in `git diff --name-only --cached | grep -E '\.(pp)'`; do
</span><span class='line'>  puppet-lint ${file}
</span><span class='line'>  if [ $? -ne 0 ]; then
</span><span class='line'>    style_bad=1
</span><span class='line'>  else
</span><span class='line'>    echo "Style looks good"
</span><span class='line'>  fi
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'>echo "Checking syntax"
</span><span class='line'>for file in `git diff --name-only --cached | grep -E '\.(pp)'`; do
</span><span class='line'>  puppet parser validate $file
</span><span class='line'>  if [ $? -ne 0 ]; then
</span><span class='line'>    syntax_bad=1
</span><span class='line'>    echo "Syntax error in ${file}"
</span><span class='line'>  else
</span><span class='line'>    echo "Syntax looks good"
</span><span class='line'>  fi
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'>for file in `git diff --name-only --cached | grep -E '\.(yaml)'`; do
</span><span class='line'>  echo "Checking YAML is valid"
</span><span class='line'>  ruby -e "require 'yaml'; YAML.parse(File.open('$file'))"
</span><span class='line'>  if [ $? -ne 0 ]; then
</span><span class='line'>    yaml_bad=1
</span><span class='line'>  else
</span><span class='line'>    echo "YAML looks good"
</span><span class='line'>  fi
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'>if [ ${yaml_bad}  ];then
</span><span class='line'>  exit 1
</span><span class='line'>elif [ ${syntax_bad}  ]; then
</span><span class='line'>  exit 1
</span><span class='line'>elif [ ${style_bad}  ]; then
</span><span class='line'>  exit 1
</span><span class='line'>else
</span><span class='line'>  exit 0
</span><span class='line'>fi
</span></code></pre></td></tr></table></div></figure>


<p>This should set you up very nicely. Your environments are completely dynamic, you have a framework in place for testing.</p>

<p>For now the deployment is with a hook script, but that is not the ultimate goal. This Git repo needs to be on the Puppet master. You may well already have a Git server you want to use. TO this end, in a later post I will be add Jenkins into the mix. As you are running the tests in an RVM environment, it will be very easy to put into Jenkins. This can then perform the deployment.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Chris Cowley</span></span>

      








  


<time datetime="2014-06-25T21:22:00+02:00" pubdate data-updated="true">Wednesday 25 June 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.chriscowley.me.uk/blog/2014/06/25/super-slick-agile-puppet-for-devops/" data-via="chriscowleyunix" data-counturl="http://www.chriscowley.me.uk/blog/2014/06/25/super-slick-agile-puppet-for-devops/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/06/17/new-linux-active-directory-integration/" title="Previous Post: New Linux Active Directory Integration">&laquo; New Linux Active Directory Integration</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/07/28/install-microsoft-truetype-fonts-on-fedora/" title="Next Post: Install Microsoft TrueType fonts on Fedora">Install Microsoft TrueType fonts on Fedora &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>A bilingual systems engineer based in rainy Brittany with a passion for open source solutions</p>
  <p><a href="http://files.chriscowley.me.uk/ChrisCowley-pubkey.asc.html">My PGP Key</a>"


</section>
<a href="http://www.blogwithintegrity.com/"><img src="http://www.blogwithintegrity.com/badges/BWI_150sq.jpg" border="0" alt="BlogWithIntegrity.com"/></a>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/07/28/install-microsoft-truetype-fonts-on-fedora/">Install Microsoft TrueType fonts on Fedora</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/25/super-slick-agile-puppet-for-devops/">Super Slick Agile Puppet for Devops</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/06/17/new-linux-active-directory-integration/">New Linux Active Directory Integration</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/10/home-made-energy-bars/">Home-made Energy Bars</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/09/vmware-cli-on-ubuntu-saucy-salamander/">VMware CLI on Ubuntu Saucy Salamander</a>
      </li>
    
  </ul>
</section>
<script type="text/javascript">
  ( function() {
  if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
    var unit = {"publisher":"chriscowley","width":160,"height":160,"sid":"Chitika Default"};
    var placement_id = window.CHITIKA.units.length;
    window.CHITIKA.units.push(unit);
    document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.src = '//cdn.chitika.net/getads.js';
    try { document.getElementsByTagName('head')[0].appendChild(s); } catch(e) { document.write(s.outerHTML); }
  }());
</script>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("chriscowleyunix", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/chriscowleyunix" class="twitter-follow-button" data-show-count="false">Follow @chriscowleyunix</a>
  
</section>

<iframe height='454' width='250' frameborder='0' allowtransparency='true' scrolling='no' src='http://app.strava.com/athletes/1988717/latest-rides/a36a00e7b429238653218b855633d03f5fd0e7ae'></iframe>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/chriscowley">@chriscowley</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'chriscowley',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/104270895010699552462?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>


<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>

  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'justanotherlinuxblog'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



<!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik-chriscowley.rhcloud.com/" : "http://piwik-chriscowley.rhcloud.com/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://piwik-chriscowley.rhcloud.com/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->


</body>
</html>
