
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Just Another Linux Blog</title>
  <meta name="author" content="Chris Cowley">

  
  <meta name="description" content="This based on my last post where I documented building a Highly Available NFS/NAS server. There is not a huge amount that needs to be done in order &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://http://warm-sword-7449.herokuapp.com//blog/page/2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Just Another Linux Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript">
    // Avoid conflict with ender.js.
    jQuery.noConflict();
</script>
<!-- jQuery Form Plugin -->
<script src="http://malsup.github.com/jquery.form.js"></script>
<!-- jQuery Form Validation Plugin -->
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.9/jquery.validate.min.js"></script> 
<script src="/javascripts/google_form.js"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32843690-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Just Another Linux Blog</a></h1>
  
    <h2>maybe a bit about cycling as well</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.duckduckgo.com/" method="get">
  <fieldset role="search">
    <input type="hidden" name="sites" value="site:http://warm-sword-7449.herokuapp.com/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search&hellip;"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/cv">CV</a></li>
  <li><a href="/contact">Contact</a></li>
  <li><a href="/yum">Yum</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/20/add-san-functions-to-highly-available-nfs-slash-nas/">Add SAN Functions to Highly Available NFS/NAS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-20T21:07:00+00:00" pubdate data-updated="true">Monday 20 February 2012</time>
        
         | <a href="/blog/2012/02/20/add-san-functions-to-highly-available-nfs-slash-nas/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This based on my last post where I documented building a Highly Available NFS/NAS server.</p>

<p>There is not a huge amount that needs to be done in order to add iSCSI functionality as well.</p>

<p>Add a file called <em>/etc/drbd/iscsi.res</em> containing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource iscsi {
</span><span class='line'>    on nfs1 {
</span><span class='line'>        device /dev/drbd1;
</span><span class='line'>        disk   /dev/vdc;
</span><span class='line'>        meta-disk internal;
</span><span class='line'>        address   10.0.0.1:7789;
</span><span class='line'>    }
</span><span class='line'>    on nfs2 {
</span><span class='line'>        device /dev/drbd1;
</span><span class='line'>        disk   /dev/vdc;
</span><span class='line'>        meta-disk internal;
</span><span class='line'>        address   10.0.0.2:7789;
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>This differs from the previous resource in 2 ways. Obviously it using a different physical disk. Also the port number of the address is incremented; each resource has to have its own port to communicate on.</p>

<h2>Configure Heartbeat</h2>

<p>Add a new resource to <em>/etc/ha.d/haresources</em>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iscsi1.snellwilcox.local IPaddr::10.0.0.101/24/eth0 drbddisk::iscsi tgtd</span></code></pre></td></tr></table></div></figure>


<p>Same primary host, new IP address, new drbd resource and of course the service to be controlled (tgtd in this case).</p>

<p>I also made a couple of changes to <em>/etc/ha.d/ha.cf</em>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>keepalive 500ms
</span><span class='line'>deadtime 5
</span><span class='line'>warntime 10
</span><span class='line'>initdead 120</span></code></pre></td></tr></table></div></figure>


<p>This changes the regularity of the heartbeat packets from every 2 seconds to 2 every second. We also say that a node is dead after only 5 seconds rather than after 30.</p>

<h2>Configure an iSCSI Target</h2>

<p>Tgtd has a config file that you can use in <em>/etc/tgt/targets.conf</em>. It is an XML file, so add entry like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;target iqn.2011-07.world.server:target0&gt;
</span><span class='line'>        # provided devicce as a iSCSI target
</span><span class='line'>        backing-store /dev/vg_matthew/lv_iscsi1
</span><span class='line'>        # iSCSI Initiator's IP address you allow to connect
</span><span class='line'>        initiator-address 192.168.1.20
</span><span class='line'>        # authentication info ( set anyone you like for "username", "password" )
</span><span class='line'>&lt;/target&gt;</span></code></pre></td></tr></table></div></figure>


<p>The target name is by convention <em>iqn.year-month.reverse-domainname:hostname.targetname</em>. Each backing store will be a seperate LUN. A discussion of this is out of the scope of this article.</p>

<p>By default, this config file is disabled. Enable it by un-commenting the line <code>#TGTD_CONFIG=/etc/tgt/targets.conf</code> in <em>/etc/sysconfig/tgtd</em>. You can now enable the target with service tgtd reload.</p>

<p>Now when you run <code>tgtadm –mode target –op show</code> you should get something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Target 1: iqn.2012-03.com.example:iscsi.target1
</span><span class='line'>    System information:
</span><span class='line'>        Driver: iscsi
</span><span class='line'>        State: ready
</span><span class='line'>    I_T nexus information:
</span><span class='line'>    LUN information:
</span><span class='line'>        LUN: 0
</span><span class='line'>            Type: controller
</span><span class='line'>            SCSI ID: IET     00010000
</span><span class='line'>            SCSI SN: beaf10
</span><span class='line'>            Size: 0 MB, Block size: 1
</span><span class='line'>            Online: Yes
</span><span class='line'>            Removable media: No
</span><span class='line'>            Readonly: No
</span><span class='line'>            Backing store type: null
</span><span class='line'>            Backing store path: None
</span><span class='line'>            Backing store flags:
</span><span class='line'>        LUN: 1
</span><span class='line'>            Type: disk
</span><span class='line'>            SCSI ID: IET     00010001
</span><span class='line'>            SCSI SN: beaf11
</span><span class='line'>            Size: 8590 MB, Block size: 512
</span><span class='line'>            Online: Yes
</span><span class='line'>            Removable media: No
</span><span class='line'>            Readonly: No
</span><span class='line'>            Backing store type: rdwr
</span><span class='line'>            Backing store path: /dev/drbd/by-res/iscsi
</span><span class='line'>            Backing store flags:
</span><span class='line'>    Account information:
</span><span class='line'>    ACL information:
</span><span class='line'>        ALL</span></code></pre></td></tr></table></div></figure>


<h2>Connect An Initiator</h2>

<p>Install the iscsi utils:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install iscsi-initiator-utils
</span><span class='line'>chkconfig iscsi on
</span><span class='line'>chkconfig iscsid on</span></code></pre></td></tr></table></div></figure>


<p>Discover the targets on the host and login to the target.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iscsiadm -m discovery -t sendtargets -p 10.0.0.101
</span><span class='line'>iscsiadm -m node --login</span></code></pre></td></tr></table></div></figure>


<p>If you run <code>cat /proc/partitions</code> you will see an new partition has appeared. You can do whatever you want with it.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/08/home-made-redundant-thin-provisioned-san/">Home-made Redundant Thin-provisioned SAN</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-08T20:02:00+00:00" pubdate data-updated="true">Wednesday 08 February 2012</time>
        
         | <a href="/blog/2012/02/08/home-made-redundant-thin-provisioned-san/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The inspiration for this came from a mixture of problems I was having with my HP P2000, ideas that have been floating around my head for a while, plus a post over at Bauer-power.net. Basically I got given a bunch of warranty returned Supermicro servers from our Customer Service guys  and got tasked with making it our secondary VMware store and DR snapshot storage. Incidentally, the Supermicro servers are used for our Channel-in-a-box product for those you in the broadcast world. They are not ideal, the 2U 12 disk models that Pablo uses are far more suitable.</p>

<p>Plenty of companies already build their arrays on commodity hardware like these, so I am not doing anything new:</p>

<ul>
<li> Dell Compellent (Supermicro, soon to be Dell)</li>
<li> CoRAID (Supermicro)</li>
<li> EMC  Clarion and VNX</li>
<li> HP P4000 (HP DL180)</li>
<li> 3Par</li>
<li> Pure Storage</li>
<li> Nutanix</li>
<li> Solid Fire</li>
</ul>


<p>My set up is basically the same as that used by Pablo in the second iteration of his array:</p>

<ul>
<li> Linux</li>
<li> GlusterFS</li>
<li> Tgtd</li>
<li> Heartbeat</li>
</ul>


<p>There are a couple of differences:</p>

<ul>
<li> Mine uses a new version of GlusterFS which is currently in beta. This has several new features, the one I am interested in is Granular Locking. As I am storing VM images, I do not want these being locked during a self-heal – a problem in 3.2 and before. There are also other things such as object-storage (Amazon S3 compatible) for use with Open Stack. I’d love that, but I am not using it in my environment :( .</li>
<li> I am building on top of CentOS. I started with Red Hat and will continue to use it for server environments in the forceeable future.</li>
<li> I do not have de-duplication as I am not using ZFS, I am running on top of Ext4 and will use XFS or BTRFS if I need to. I am only using 8x 1TB drives as that is what I got given for free.</li>
</ul>


<p>I have had to build a couple of custom RPMS which I have made available in my <a href="http://yum.chriscowley.me.uk/el/6/x86_64/repoview/" target="blank">Yum repository</a>.</p>

<p>I did investigate de-duplication using LessFS, but sadly that is a no go as it does not currently support Extended Attributes, which are required by GlusterFS.</p>

<h2>Installation</h2>

<p>Install a basic CentOS 6 system on each node – the base system will be fine.</p>

<p>The two servers are</p>

<ul>
<li>server1 192.168.1.1(eth0),10.0.0.1(eth1)</li>
<li>server2 192.168.1.2(eth0),10.0.0.2(eth1)</li>
</ul>


<p>They connect to the rest of your network using eth0 and eth1 is a dedicated link between the 2. I would put them via a seperate switches/vLANs rather than a direct link, that way you can scale out your pool easily.</p>

<p>In the hosts file add:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>10.0.0.1 server1.example.com
</span><span class='line'>10.0.0.2 server2.example.com</span></code></pre></td></tr></table></div></figure>


<p>Add my repository:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rpm --import http://yum.chriscowley.me.uk/RPM-GPG-KEY-ChrisCowley
</span><span class='line'>yum install http://yum.chriscowley.me.uk/el/6/x86_64/RPMS/chriscowley-release-1-1.noarch.rpm
</span><span class='line'>rpm --import https://fedoraproject.org/static/0608B895.txt
</span><span class='line'>yum install http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-5.noarch.rpm</span></code></pre></td></tr></table></div></figure>


<p>Now you can install the necessary packages, which is not many. :</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install glusterfs-core glusterfs-fuse heartbeat scsi-target-utils</span></code></pre></td></tr></table></div></figure>


<p>Now you can add create a pool of servers:</p>

<h2>GlusterFS</h2>

<p>From server1:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gluster peer probe server2</span></code></pre></td></tr></table></div></figure>


<p>You next step is to configure a Gluster Volume. Gluster’s documentation for this is excellent. For our simple 2-node cluster we just want a simple replicated volume. As you grow, you can simple add extra pairs of nodes to expand your storage pool.</p>

<p>On each node create a folder to store the data and a mount-point for the replicated data:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir /exp1
</span><span class='line'>mkdir /mnt/test-volume</span></code></pre></td></tr></table></div></figure>


<p>Now create your volume and activate it(on a single node):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gluster volume create test-volume replica 2 transport tcp server1:/exp1 server2:/exp1
</span><span class='line'>gluster volume start test-volume</span></code></pre></td></tr></table></div></figure>


<p>Now you need to mount that volume on each of your nodes.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo "`hostname`:/test-volume /mnt/test-volume glusterfs defaults,noauto,_netdev 0 0" >> /etc/fstab
</span><span class='line'>echo "mount /mnt/test-volume" >> /etc/rc.local
</span><span class='line'>mount /mnt/test-volume</span></code></pre></td></tr></table></div></figure>


<h2>Heartbeat</h2>

<p>Now you need to configure heartbeat to control a floating IP address and the associated TGTD service. You need to create a few files on each node.</p>

<p>/etc/ha.d/authkeys:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>auth 2
</span><span class='line'>2 crc</span></code></pre></td></tr></table></div></figure>


<p>/etc/ha.d/ha.cf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>logfacility     local0
</span><span class='line'>keepalive 500ms
</span><span class='line'>deadtime 5
</span><span class='line'>warntime 10
</span><span class='line'>initdead 120
</span><span class='line'>bcast eth1
</span><span class='line'>node server1
</span><span class='line'>node server2
</span><span class='line'>auto_failback no</span></code></pre></td></tr></table></div></figure>


<p>/etc/ha.d/haresources:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>server1 IPaddr::192.168.1.3/24/eth0 tgtd</span></code></pre></td></tr></table></div></figure>


<p>There are a couple of considerations. The Gluster filesystems need to be mounted before tgtd starts. Tgtd is in turn controled by Heartbeat (see the above haresources file). To this end make sure both heartbeat and tgtd are disabled and start heartbeat from /etc/rc.local.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>echo "/etc/init.d/heartbeat start" >> /etc/rc.local</span></code></pre></td></tr></table></div></figure>


<p>With all this done on both nodes, you can now start heartbeat on each node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/init.d/heartbeat start</span></code></pre></td></tr></table></div></figure>


<p>Checking ifconfig will show that one of your nodes now has an <em>eth0:0</em> address.You will also find that tgtd is also running on that same node.</p>

<h2>iSCSI Target</h2>

<p>First create yourself a file to use as the backend for your iSCSI target:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dd if=/dev/zero bs=1M count=40000 of=/mnt/test-volume/test.img</span></code></pre></td></tr></table></div></figure>


<p>or, if you prefer thin provisioned:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dd if=/dev/zero bs=1M seek=40000 count=0 of=/mnt/test-volume/test.img</span></code></pre></td></tr></table></div></figure>


<p>You now need to define this file as a target. This requires the editting of 2 files.</p>

<p>/etc/sysconfig/tgtd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>TGTD_CONFIG=/etc/tgt/targets.conf</span></code></pre></td></tr></table></div></figure>


<p>/etc/tgtd/targets.conf, make sure there is an entry such as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;target iqn.2012-02.com.example.gluster:isci>
</span><span class='line'>    backing-store /mnt/test-volume/test.img
</span><span class='line'>    initiator-address 192.168.1.10
</span><span class='line'>&lt;/target></span></code></pre></td></tr></table></div></figure>


<p>This will make that image file you created available to the client with the address 192.168.1.10. This targets.conf file is extremely well commented, so have a read. Now just tell tgtd to reload its configuration from the live node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/etc/init.d/tgtd reload</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Nothing here is particularly complicated, but it does give you a lot of storage for a very low price, using a very enterprise friendly OS.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/06/vmware-cli-installation-woes-on-centos-6/">VMware CLI Installation Woes on Centos 6</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-06T13:09:00+00:00" pubdate data-updated="true">Monday 06 February 2012</time>
        
         | <a href="/blog/2012/02/06/vmware-cli-installation-woes-on-centos-6/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Installing the VMware CLI should have been simple, but it was a bit of a fiddle.</p>

<p>Use yum  all the bits it needs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install make autoconf automake openssl-devel gcc gcc-c++ make uuid-perl libuuid-devel uuid-devel  perl-Data-Dump perl-SOAP-Lite perl-XML-SAX perl-XML-NamespaceSupport perl-XML-LibXML perl-XML-LibXML-Common perl-CPAN</span></code></pre></td></tr></table></div></figure>


<p>You should now be able to run the installer, but I had another problem though. The installer script would not believe me that I had a direct internet connection and insisted that I gave some proxy server settings. As a simple workaround I just commented out that code in the installation script:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>if ( direct_command("env | grep -i http_proxy") ) {
</span><span class='line'> $httpproxy = 1;
</span><span class='line'>} else {
</span><span class='line'> print wrap("http_proxy not set. please set environment variable 'http_proxy' e.g. export http_proxy=http://myproxy.mydomain.com:0000 . \n\n", 0);
</span><span class='line'>}
</span><span class='line'>if ( direct_command("env | grep -i ftp_proxy") ) {
</span><span class='line'> $ftpproxy = 1;
</span><span class='line'>} else {
</span><span class='line'> print wrap("ftp_proxy not set. please set environment variable 'ftp_proxy' e.g. export ftp_proxy=http://myproxy.mydomain.com:0000 . \n\n", 0);
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>if ( !( $ftpproxy && $httpproxy)) {
</span><span class='line'>    uninstall_file($gInstallerMainDB);
</span><span class='line'>    exit 1;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>After this I was able to run the installer with no problems. Of course, there is still the problem I have VMware about them putting their files under <em>/usr</em>. If it is not under control of my package manager, the default should be <em>/opt</em> or <em>/usr/local</em>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/11/10/open-source-storage/">Open Source Storage</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-11-10T13:12:00+00:00" pubdate data-updated="true">Thursday 10 November 2011</time>
        
         | <a href="/blog/2011/11/10/open-source-storage/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have searchstorage.co.uk send me potentially interesting white-papers regularly. If I am honest, most of them or thinly veiled press-releases. However occasionally one is interesting.</p>

<p>Today I received one entitled <a href="/downloads/ITinEU_Storage_autumn11_final.pdf">Break free of vendor lock-in with open source storage</a>. Being a FLOSS fan and a storage specialist, that obviously intrigued me.</p>

<p>The article of interest starts on page 8 and is pretty good. It mentions all the main players; unusually it is not condescending towards Open Source (i.e. it will get you by until you can afford to buy a proper/stupidly-over-priced solution).</p>

<p>It also mentions <a href="http://www.gluster.org" target="_blank">GlusterFS</a>, which is particularly interesting. I have just built a solution at work built around this and it excellent. I will be putting more info up soon as a complete how-to on building a full-featured, high availability SAN/NAS.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/10/16/ubuntu-upgrade-problems/">Ubuntu Upgrade Problems</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-10-16T13:24:00+01:00" pubdate data-updated="true">Sunday 16 October 2011</time>
        
         | <a href="/blog/2011/10/16/ubuntu-upgrade-problems/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Usually the release upgrade is relatively trouble-free, but this time I had a minor problem. After the upgrade I had no X Windows. It turned out that the NVidia driver not loading.</p>

<p>I had to boot it up in rescue mode, which is selectable from the Grub menu. From there I could drop to a root console.</p>

<p>The first step is to remount / as read-write and then mount my boot partition (/dev/sda1).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mount -o rw,remount /
</span><span class='line'>mount /dev/sda1 /boot</span></code></pre></td></tr></table></div></figure>


<p>Now I just need to move the xorg.conf to one side and reinstall the nvidia driver</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mv /etc/X11/xorg.conf /etc/X11/xorg.conf.bak
</span><span class='line'>apt-get remove nvidia-current && apt-get install nvidia-current</span></code></pre></td></tr></table></div></figure>


<p>After a reboot it should come up all fine and dandy.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/05/04/sms-from-icinga-or-nagios/">SMS From Icinga or Nagios</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-04T13:26:00+01:00" pubdate data-updated="true">Tuesday 04 May 2010</time>
        
         | <a href="/blog/2010/05/04/sms-from-icinga-or-nagios/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Finding out how to have Nagios (or in my case Icinga) send SMS alerts is easy. However, from my point of view it fell down in 2 ways.</p>

<ol>
<li>Most of these guides are Debian specific, I am using Centos.</li>
<li>The SMS alerts are all or nothing, I only want SMS alerts for specific services (such as the corporate website).</li>
</ol>


<h2>Hardware</h2>

<p>First things first you need something to send the SMS. I am using a brand new Vodaphone USB dongle taped to the side of the rack . I also had it working with a Nokia E51 using the same tools – obviously this would the require constant charging.</p>

<p>Ideally I would have prefered to use an internal card. PCI -> PC card bridges do exist, but I had no joy on my Icinga server, although it did work in a Dell Optiplex we had lying around, but it caused an HP XW4600 not to switch on at all.</p>

<h2>Software</h2>

<p>I am using <a href="http://smstools3.kekekasvi.com/" target="_blank">SMS Server Tools 3</a> which are available for Centos/RHEL in <a href="https://fedoraproject.org/wiki/EPEL" target="_blank">EPEL</a>. This gives you an smsd daemon that watches a folder for text messages in a particular format.</p>

<p>When you have enabled EPEL run</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>yum install smstools
</span><span class='line'>chkconfig –levels 35 smsd on</span></code></pre></td></tr></table></div></figure>


<p>When I plugged in the USB dongle I got a pair of USB ttys at /dev/ttyUSB0 and /dev/ttyUSB1</p>

<p>Add the following to /etc/smsd.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>devices = GSM1
</span><span class='line'>logfile = /var/log/smsd.log
</span><span class='line'>loglevel = 7
</span><span class='line'>
</span><span class='line'>ARVE Error: no video ID
</span><span class='line'>device = /dev/ttyUSB0
</span><span class='line'>smsc = 447785016005 # I am using Vodaphone, your’s may vary.
</span><span class='line'>incoming = no</span></code></pre></td></tr></table></div></figure>


<p>Now you can start the daemon</p>

<pre><code>/etc/init.d/smsd start
</code></pre>

<p>Finally, for reasons explained later, you need an entry in icinga’s cron.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>* * * * * if [[ `ls /tmp/ | grep 'sms-icinga' | wc -l` -gt 0 ]];then /bin/mv /tmp/sms-icinga* /var/spool/sms/outgoing/;fi</span></code></pre></td></tr></table></div></figure>


<p>What does this do? It checks “/tmp/” for any files that contain the name “sms-icinga” every minute. If any exist it moves them to “/var/spool/sms/outgoing/”. That last folder is watched by smsd for those special text files mentioned above.
Icinga/Nagios configuration</p>

<p>First add the commands, for which I use the file /etc/icinga/objects/commands.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define command {
</span><span class='line'>    command_name notify-host-by-sms
</span><span class='line'>    command_line /usr/bin/printf “%b” “To: $CONTACTPAGER$\n\n$NOTIFICATIONTYPE$\nHost Alert: $HOSTNAME$ is $HOSTSTATE$\n” &gt; /tmp/sms-icinga.$HOSTNAME$.$HOSTSTATE$.$CONTACTPAGER$
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define command {
</span><span class='line'>    command_name notify-service-by-sms
</span><span class='line'>    command_line /usr/bin/printf “%b” “To: $CONTACTPAGER$\n\n$NOTIFICATIONTYPE$\nService Alert:     $SERVICEDESC$ on $HOSTNAME$ is $SERVICESTATE$” &gt; /tmp/sms-icinga.$SERVICEDESC$.$HOSTNAME$.$CONTACTPAGER$
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>These commands write a file in /tmp that includes the string sms-icinga that our cron script looks for. The rest of it is to endure we do not accidentally overwrite an alert that has not been sent yet. The reason we need to write it into tmp, and the mv it to the outgoing folder is a little weird. I found that if I wrote directly to the outgoing folder, then smsd seemed picked it up too early and failed to parse the file correctly – strange, but not to worry.</p>

<p>Now is where need to fiddle things a little bit if we only want to send messages for certain critical services. If you want SMS alerts for all your services you can just add a pager entry to all you contacts. We need to create an SMS user and a couple of templates to base our critical stuff on.</p>

<p>The templates:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define contact {
</span><span class='line'>    name sms-contact
</span><span class='line'>    use generic-contact
</span><span class='line'>    service_notification_commands notify-service-by-sms, notify-service-by-email
</span><span class='line'>    host_notification_commands notify-host-by-sms, notify-host-by-email
</span><span class='line'>    register 0
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define service {
</span><span class='line'>    use generic-service
</span><span class='line'>    name critical-service
</span><span class='line'>    contact_groups admins-sms,linux-admin
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>define host {
</span><span class='line'>    name critical-host
</span><span class='line'>    use generic-host
</span><span class='line'>    contact_groups admins-sms,linux-admin
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>my user:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define contact {
</span><span class='line'>    contact_name ChrisCowley-SMS
</span><span class='line'>    use sms-contact
</span><span class='line'>    pager &lt;my-mobile-number&gt;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>a contact group:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define contactgroup {
</span><span class='line'>    contactgroup_name admins-sms
</span><span class='line'>    members ChrisCowley-SMS
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Finally we can create our essential service:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>define service {
</span><span class='line'>    use critical-service
</span><span class='line'>    service_description Website-content
</span><span class='line'>    check_command check_http_content!-U http://www.snellgroup.com -m Snell
</span><span class='line'>    host_name www.snellgroup.com
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/01/12/some-great-new-san-gear/">Some Great New SAN Gear</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-01-12T13:35:00+00:00" pubdate data-updated="true">Tuesday 12 January 2010</time>
        
         | <a href="/blog/2010/01/12/some-great-new-san-gear/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Just before Christmas I was up at a storage seminar run by a company called <a href="http://www.dothill.com/" target="_blank">Dot Hill</a>. Until I was pointed to them when I spoke to our storage supplier about replacing an aging array I had never heard of them. However, it turns out that they make the hardware used by HP, NetApp and others – quite a pedigree then.</p>

<p>All their products are completely modular, based on the same chassis. If you have an iSCSI unit, then you can later change it into a FC one and you do not have to migrate anything as the array config is not stored on the controllers.</p>

<p>They have some very clever technologies as well. In most arrays, the cache on the controllers need to be kept in sync. This generally goes through the backplane. In the Dot Hill arrays, there is dedicated circuitry that goes directly between the controllers – much faster! I also like the fact that they no longer use batteries, but instead use supercapacitors which are much greener.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/17/mirror-a-subversion-repo-with-svnsync/">Mirror a Subversion repo with svnsync</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/03/fixed-my-gihub-repo-list/">Fixed my gihub repo list</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/03/excellent-seminar-given-by-a-friend-of-mine/">Excellent seminar given by a friend of mine</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/23/installing-postgresql-on-fedora-17/">Installing PostgreSQL on Fedora 17</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/18/skype-video-on-fedora-64bit/">Skype video on Fedora 64bit</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/chriscowley">@chriscowley</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'chriscowley',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("chriscowleyunix", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/chriscowleyunix" class="twitter-follow-button" data-show-count="false">Follow @chriscowleyunix</a>
  
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/104270895010699552462?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Chris Cowley -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'justanotherlinuxblog'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
